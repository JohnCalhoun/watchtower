/* api
    -gremlin
        
*/
"Api":{
    "Type" : "AWS::ApiGateway::RestApi",
    "Properties" : {
        "Name" : {"Ref":"AWS::StackName"}
    }
},
"ApiDeployment":{
    "Type" : "AWS::ApiGateway::Deployment",
    "Properties" : {
        "RestApiId" : {"Ref":"Api"}
    },
    "DependsOn":["SubmitGremlinMethod"]
},
"ApiStage":{
    "Type" : "AWS::ApiGateway::Stage",
    "Properties" : {
        "DeploymentId" : {"Ref":"ApiDeployment"},
        "RestApiId" : {"Ref":"Api"},
        "StageName" : "production",
        "Variables":{
            "server":{"Fn::GetAtt":["ELB","DNSName"]}
        }
    }
},
"GremlinResource":{
    "Type" : "AWS::ApiGateway::Resource",
    "Properties" : {
        "ParentId" :{ "Fn::GetAtt": ["Api", "RootResourceId"] } ,
        "PathPart" : "gremlin",
        "RestApiId" : {"Ref":"Api"}
    }
},
"ScriptResource":{
    "Type" : "AWS::ApiGateway::Resource",
    "Properties" : {
        "ParentId" :{"Ref":"GremlinResource"} ,
        "PathPart" : "script",
        "RestApiId" : {"Ref":"Api"}
    }
},
"HealthCheckResource":{
    "Type" : "AWS::ApiGateway::Resource",
    "Properties" : {
        "ParentId" :{"Ref":"GremlinResource"} ,
        "PathPart" : "healthcheck",
        "RestApiId" : {"Ref":"Api"}
    }
},
"IAMAuthorizor":{
    "Type" : "AWS::ApiGateway::Authorizer",
    "Properties" : {
        "AuthorizerResultTtlInSeconds" : "0",
        "IdentitySource" : "method.request.header.Authorization",
        "Name" : "Admin",
        "ProviderARNs" : [{"Fn::Join":["",[
            "arn:aws:cognito-idp:",
            {"Ref":"AWS::Region"},
            ":",
            {"Ref":"AWS::AccountId"},           
            ":userpool/",
            {"Fn::GetAtt":["adminUserPool","Id"]}
        ]]}],
        "RestApiId" : {"Ref":"Api"},
        "Type" : "COGNITO_USER_POOLS"
    }
},
"ScriptModel":{
    "Type" : "AWS::ApiGateway::Model",
    "Properties" : {
        "ContentType" : "application/json",
        "Name" : "ScriptSubmit",
        "RestApiId" : {"Ref":"Api"},
        "Schema" : {
            "$schema": "http://json-schema.org/draft-04/schema#",
            "title": "Script",
            "type": "object",
            "properties": {
                "script":{
                    "type":"string"
                }
            }
        }
    }
},
"HealthcheckModel":{
    "Type" : "AWS::ApiGateway::Model",
    "Properties" : {
        "ContentType" : "application/json",
        "Name" : "Healthcheck",
        "RestApiId" : {"Ref":"Api"},
        "Schema" : {
            "$schema": "http://json-schema.org/draft-04/schema#",
            "title": "Script",
            "type": "object",
            "properties": {
                "script":{
                    "type":"string"
                }
            }
        }
    }
},
"ResponseModel":{
    "Type" : "AWS::ApiGateway::Model",
    "Properties" : {
        "ContentType" : "application/json",
        "Name" : "response",
        "RestApiId" : {"Ref":"Api"},
        "Schema" : {
            "$schema": "http://json-schema.org/draft-04/schema#",
            "title": "Script",
            "type": "object",
            "properties": {
                "script":{
                    "type":"string"
                }
            }
        }
    }
},
"SubmitGremlinMethod":{
    "Type" : "AWS::ApiGateway::Method",
    "Properties" : {
        "AuthorizationType" : "COGNITO_USER_POOLS",
        "AuthorizerId" : {"Ref":"IAMAuthorizor"},
        "HttpMethod" : "POST",
        "Integration" : {
            "Credentials" : {"Fn::GetAtt":["ApiGatewayRole","Arn"]},
            "IntegrationHttpMethod" : "POST",
            "PassthroughBehavior":"NEVER", 
            "IntegrationResponses" : [
                {
                    "ResponseTemplates": {
                        "application/json": "$input.json('$.body')"
                     },
                    "StatusCode" : "200"
                },
                {
                    "SelectionPattern": "^ERROR.*",
                    "ResponseTemplates": {
                        "application/json": "{}"
                    },
                    "StatusCode": 404
                }
            ],
            "Type" : "AWS",
            "Uri": {
                "Fn::Join": ["",[
                    "arn:aws:apigateway:",
                    {"Ref": "AWS::Region"},
                    ":lambda:path/2015-03-31/functions/",
                    {"Fn::GetAtt": ["GremlinProxy", "Arn"]},
                    "/invocations"
                  ]
                ]
              }
        },
        "MethodResponses" : [
            {
                "ResponseModels":{
                    "application/json":{"Ref":"ResponseModel"}
                },
                "StatusCode" : "200"
            },
            {
                "ResponseModels":{
                    "application/json":"Empty"
                },
                "StatusCode" : "404"
            }
        ],
        "RequestParameters" : {},
        "ResourceId" : {"Ref":"ScriptResource"},
        "RestApiId" : {"Ref":"Api"}
    }
},
"HealthCheckMethod":{
    "Type" : "AWS::ApiGateway::Method",
    "Properties" : {
        "AuthorizationType" : "NONE",
        "HttpMethod" : "GET",
        "Integration" : {
            "Credentials" : {"Fn::GetAtt":["ApiGatewayRole","Arn"]},
            "IntegrationHttpMethod" : "POST",
            "PassthroughBehavior":"NEVER", 
            "IntegrationResponses" : [
                {
                    "ResponseTemplates": {
                        "application/json": "Empty"
                     },
                    "StatusCode" : "200"
                },
                {
                    "SelectionPattern": "^ERROR.*",
                    "ResponseTemplates": {
                        "application/json": "Empty"
                    },
                    "StatusCode": 404
                }
            ],
            "Type" : "AWS",
            "Uri": {
                "Fn::Join": ["",[
                    "arn:aws:apigateway:",
                    {"Ref": "AWS::Region"},
                    ":lambda:path/2015-03-31/functions/",
                    {"Fn::GetAtt": ["GremlinProxy", "Arn"]},
                    "/invocations"
                  ]
                ]
              }
        },
        "MethodResponses" : [
            {
                "ResponseModels":{
                    "application/json":"Empty"
                },
                "StatusCode" : "200"
            },
            {
                "ResponseModels":{
                    "application/json":"Empty"
                },
                "StatusCode" : "404"
            }
        ],
        "RequestParameters" : {},
        "ResourceId" : {"Ref":"HealthCheckResource"},
        "RestApiId" : {"Ref":"Api"}
    }
}


