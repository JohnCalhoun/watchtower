/*
    security groups
        server
        lambdas 
        elb

    roles
        server
        lambdas
        users
*/
"GremlinServerSG":{
    "Type" : "AWS::EC2::SecurityGroup",
    "Properties" : {
        "GroupDescription":"Allows server to take in http traffic and lambda REDIS request",
        "SecurityGroupIngress" : [ 
            {
                "FromPort" : "8182",
                "ToPort" : "8182",
                "IpProtocol" : "tcp",
                "SourceSecurityGroupId" : {"Ref":"ELBSG"}
            }
        ],
        "VpcId" : {"Ref":"VPC"}
    }
},
"ELBSG":{
    "Type" : "AWS::EC2::SecurityGroup",
    "Properties" : {
        "GroupDescription":"Allows traffic through load balancer",
        "SecurityGroupIngress" : [ 
            {
                "FromPort" : "80",
                "ToPort" : "80",
                "IpProtocol" : "tcp",
                "SourceSecurityGroupId" : {"Ref":"GremlinlambdaSG"}
            },
            {
                "FromPort" : "443",
                "ToPort" : "443",
                "IpProtocol" : "tcp",
                "SourceSecurityGroupId" : {"Ref":"GremlinlambdaSG"}
            }
        ],
        "VpcId" : {"Ref":"VPC"}
    }
},
"GremlinlambdaSG":{
    "Type" : "AWS::EC2::SecurityGroup",
    "Properties" : {
        "GroupDescription":"na",
        "SecurityGroupIngress" : [],
        "VpcId" : {"Ref":"VPC"}
    }
},
"GremlinServerProfile":{
    "Type": "AWS::IAM::InstanceProfile",
    "Properties": {
        "Path": "/",
        "Roles": [ {"Ref":"GremlinServerRole"} ]
    }
},
"GremlinServerRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
        "AssumeRolePolicyDocument": { 
            "Version" : "2012-10-17",
            "Statement": [ {
                "Effect": "Allow",
                "Principal": {
                    "Service": [ "ec2.amazonaws.com" ]
                },
                "Action": [ "sts:AssumeRole" ]
            }]
        },
        "Path": "/",
        "Policies": [
             {
                "PolicyName":"DynamoDB",
                "PolicyDocument":{
                "Version": "2012-10-17",
                "Statement": [
                    {
                    "Action": [
                        "dynamodb:*"
                    ],
                    "Effect": "Allow",
                    "Resource": [
                        {"Fn::Join":["",[
                            "arn:aws:dynamodb:",
                            {"Ref":"AWS::Region"},
                            ":",
                            {"Ref":"AWS::AccountId"},
                            ":",
                            "table/",
                            {"Ref":"edgestore"}
                        ]]},
                        {"Fn::Join":["",[
                            "arn:aws:dynamodb:",
                            {"Ref":"AWS::Region"},
                            ":",
                            {"Ref":"AWS::AccountId"},
                            ":",
                            "table/",
                            {"Ref":"graphindex"}
                        ]]},
                        {"Fn::Join":["",[
                            "arn:aws:dynamodb:",
                            {"Ref":"AWS::Region"},
                            ":",
                            {"Ref":"AWS::AccountId"},
                            ":",
                            "table/",
                            {"Ref":"systemProperties"}
                        ]]},
                        {"Fn::Join":["",[
                            "arn:aws:dynamodb:",
                            {"Ref":"AWS::Region"},
                            ":",
                            {"Ref":"AWS::AccountId"},
                            ":",
                            "table/",
                            {"Ref":"titanIds"}
                        ]]},
                        {"Fn::Join":["",[
                            "arn:aws:dynamodb:",
                            {"Ref":"AWS::Region"},
                            ":",
                            {"Ref":"AWS::AccountId"},
                            ":",
                            "table/",
                            {"Ref":"txlog"}
                        ]]},
                        {"Fn::Join":["",[
                            "arn:aws:dynamodb:",
                            {"Ref":"AWS::Region"},
                            ":",
                            {"Ref":"AWS::AccountId"},
                            ":",
                            "table/",
                            {"Ref":"systemlog"}
                        ]]}
                    ]
                    }
                ]
                }
            },
            {
                "PolicyName":"s3logput",
                "PolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "s3:PutObject"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                { "Fn::Join" : ["", [
                                "arn:aws:s3:::", 
                                {"Fn::FindInMap":["Buckets","log","name"]},
                                "/*" ]]},
                                { "Fn::Join" : ["", [
                                "arn:aws:s3:::", 
                                {"Fn::FindInMap":["Buckets","log","name"]},
                                ]]}
                            ]
                        }
                    ]
                }
            },
            {
                "PolicyName":"s3getbootstrap",
                "PolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "s3:GetObject",
                                "s3:ListBucket",
                                "s3:ListObjects"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                { "Fn::Join" : ["", [
                                "arn:aws:s3:::", 
                                {"Fn::FindInMap":["Buckets","assets","name"]},
                                "/disclosure/*" ]]},
                                { "Fn::Join" : ["", [
                                "arn:aws:s3:::", 
                                {"Fn::FindInMap":["Buckets","assets","name"]}
                                ]]}
                            ]
                        }
                    ]
                }
            },
            {
                "PolicyName":"getESendpoint",
                "PolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "es:*"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {"Fn::Join":["",[ 
                                    "arn:aws:es:",
                                    {"Ref":"AWS::Region"},
                                    ":",
                                    {"Ref":"AWS::AccountId"}, 
                                    ":domain/",
                                    {"Ref":"AWS::StackName"},
                                    "-",
                                    "elasticsearch"
                                ]]}
                            ]
                        }
                    ]
                }
            }
        ]
    }
},
"CreateHealthCheckRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
         "AssumeRolePolicyDocument": { 
            "Version" : "2012-10-17",
            "Statement": [ {
                "Effect": "Allow",
                "Principal": {
                    "Service": [ "lambda.amazonaws.com" ]
                },
                "Action": [ "sts:AssumeRole" ]
            }]
        },
        "Path": "/",
        "ManagedPolicyArns":[
            "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        ],
        "Policies": [ 
            {
                "PolicyName":"S3PutGet",
                "PolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                    {
                        "Effect": "Allow",
                        "Action": [
                            "s3:DeleteObject",
                            "s3:PutObject",
                            "s3:ListObjects"
                        ],
                        "Resource":[
                            { "Fn::Join" : ["", [
                            "arn:aws:s3:::", 
                            { "Ref" : "HostingBucket" },
                            "/*" ]]},
                            { "Fn::Join" : ["", [
                            "arn:aws:s3:::", 
                            { "Ref" : "HostingBucket" } 
                            ]]}
                        ]
                    }
                    ]
              }
            }
        ]
    }
},
"CreateCognitoPoolRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
         "AssumeRolePolicyDocument": { 
            "Version" : "2012-10-17",
            "Statement": [ {
                "Effect": "Allow",
                "Principal": {
                    "Service": [ "lambda.amazonaws.com" ]
                },
                "Action": [ "sts:AssumeRole" ]
            }]
        },
        "Path": "/",
        "ManagedPolicyArns":[
            "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        ],
        "Policies": [ 
            {
                "PolicyName":"CreateCognitoPool",
                "PolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                    {
                        "Effect": "Allow",
                        "Action": [
                            "cognito-idp:CreateUserPool",  
                            "cognito-idp:CreateUserPoolClient", 
                            "cognito-idp:DeleteUserPool",  
                            "cognito-idp:DeleteUserPoolClient" 
                        ],
                        "Resource":"*"
                    }
                    ]
              }
            }

        ]
    }
},
"GremlinProxyRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
         "AssumeRolePolicyDocument": { 
            "Version" : "2012-10-17",
            "Statement": [ {
                "Effect": "Allow",
                "Principal": {
                    "Service": [ "lambda.amazonaws.com" ]
                },
                "Action": [ "sts:AssumeRole" ]
            }]
        },
        "Path": "/",
        "ManagedPolicyArns":[
            "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess",
            "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
        ]
    }
},
"CreateCognitoIdentityRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
         "AssumeRolePolicyDocument": { 
            "Version" : "2012-10-17",
            "Statement": [ {
                "Effect": "Allow",
                "Principal": {
                    "Service": [ "lambda.amazonaws.com" ]
                },
                "Action": [ "sts:AssumeRole" ]
            }]
        },
        "Path": "/",
        "ManagedPolicyArns":[
            "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        ],
        "Policies": [ 
            {
                "PolicyName":"CreateCognitoPool",
                "PolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Stmt1482095556000",
                            "Effect": "Allow",
                            "Action": [
                                "cognito-identity:CreateIdentityPool",
                                "cognito-identity:DeleteIdentityPool",
                                "cognito-identity:SetIdentityPoolRoles",
                                "iam:PassRole"
                            ],
                            "Resource": [
                                "*"
                            ]
                        }
                    ]
                }
            }
        ]
    }
},
"AdminRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
         "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "cognito-identity.amazonaws.com"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "cognito-identity.amazonaws.com:aud": "test"
                    }
                  }
                }
              ]
            },
        "Path": "/",
        "ManagedPolicyArns":[
            "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        ],
        "Policies": [ 
        ]
    }
},
"RequesterRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
         "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "cognito-identity.amazonaws.com"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "cognito-identity.amazonaws.com:aud": "test"
                    }
                  }
                }
              ]
            },
        "Path": "/",
        "ManagedPolicyArns":[
            "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        ],
        "Policies": [ 
        ]
    }
},
"OberserverRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
         "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "cognito-identity.amazonaws.com"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "cognito-identity.amazonaws.com:aud": "test"
                    }
                  }
                }
              ]
            },
        "Path": "/",
        "ManagedPolicyArns":[
            "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        ],
        "Policies": [ 
        ]
    }
},
"unauthenticatedRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
         "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "cognito-identity.amazonaws.com"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "cognito-identity.amazonaws.com:aud": "test"
                    }
                  }
                }
              ]
            },
        "Path": "/",
        "Policies": [ 
        ]
    }
},
"ApiGatewayRole":{
    "Type": "AWS::IAM::Role",
    "Properties": {
         "AssumeRolePolicyDocument": { 
            "Version" : "2012-10-17",
            "Statement": [ {
                "Effect": "Allow",
                "Principal": {
                    "Service": [ "apigateway.amazonaws.com" ]
                },
                "Action": [ "sts:AssumeRole" ]
            }]
        },
        "Path": "/",
        "ManagedPolicyArns":[],
        "Policies": [
            {
                "PolicyName":"CreateCognitoPool",
                "PolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Stmt1482095556000",
                            "Effect": "Allow",
                            "Action": [
                                "lambda:invokeFunction"
                            ],
                            "Resource": [
                                "*"
                            ]
                        }
                    ]
                }
            }

        
        
        ]
    }
}
